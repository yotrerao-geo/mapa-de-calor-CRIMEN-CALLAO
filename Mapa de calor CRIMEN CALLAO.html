# ===============================================================
# MAPA INTERACTIVO FINAL CON SHAPEFILE + HEATMAP (JET)
# ESTRELLAS DIN√ÅMICAS + OPACIDAD ADAPTATIVA POR CAPA BASE
# ===============================================================

!pip install geopandas folium shapely pyproj fiona branca

import geopandas as gpd
import folium
from folium.plugins import HeatMap
from google.colab import files
import zipfile, os

# === 1. Subida del archivo ZIP con shapefile ===
print("üìÅ Sube tu archivo ZIP con el shapefile de puntos...")
uploaded = files.upload()

# Extraer el ZIP
for fn in uploaded.keys():
    if fn.endswith(".zip"):
        zip_path = fn
        break

extract_dir = "shapefile_data"
os.makedirs(extract_dir, exist_ok=True)
with zipfile.ZipFile(zip_path, 'r') as zip_ref:
    zip_ref.extractall(extract_dir)

# Buscar shapefile
shp_files = [f for f in os.listdir(extract_dir) if f.endswith(".shp")]
if not shp_files:
    raise FileNotFoundError("‚ùå No se encontr√≥ ning√∫n .shp dentro del ZIP.")
shp_path = os.path.join(extract_dir, shp_files[0])

# === 2. Cargar shapefile y reproyectar ===
gdf = gpd.read_file(shp_path)
gdf = gdf.to_crs(epsg=4326)

# === 3. Calcular centro ===
bounds = gdf.total_bounds
center = [(bounds[1] + bounds[3]) / 2, (bounds[0] + bounds[2]) / 2]

# === 4. Paletas base ===
paletas = {
    "OSM Est√°ndar": {"texto": "#4A4A4A"},
    "Google Maps - Calles": {"texto": "#2E2E2E"},
    "Google Sat√©lite": {"texto": "#FFFFFF"}
}

# === 5. Crear mapa base ===
m = folium.Map(location=center, zoom_start=10, control_scale=True, tiles=None)

# === 6. Capas base ===
tiles = {
    "OSM Est√°ndar": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    "Google Maps - Calles": "https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",
    "Google Sat√©lite": "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}"
}
for nombre, url in tiles.items():
    folium.TileLayer(url, name=nombre, attr=nombre, control=True).add_to(m)

# === 7. Asignar colores por tipo ===
tipos_unicos = sorted(set(gdf["Tipo"].dropna().unique())) if "Tipo" in gdf.columns else ["Punto"]
colores_primarios = ["#FF0000", "#0000FF", "#00FF00", "#FFFF00", "#FF00FF", "#00FFFF", "#FFA500"]
color_por_tipo = {tipo: colores_primarios[i % len(colores_primarios)] for i, tipo in enumerate(tipos_unicos)}

# === 8. Dibujar estrellas con sombra oscura ===
for idx, row in gdf.iterrows():
    tipo = str(row.get("Tipo", "Punto"))
    color = color_por_tipo.get(tipo, "#000000")
    folium.Marker(
        location=[row.geometry.y, row.geometry.x],
        icon=folium.DivIcon(
            html=f"""
            <div class="star-icon" style="
                font-size:14px;
                color:{color};
                text-shadow:
                    -1px -1px 1px #111111,
                     1px -1px 1px #111111,
                    -1px  1px 1px #111111,
                     1px  1px 1px #111111;
                opacity:0.85;
                transition: all 0.3s ease;
                ">
                &#9733;
            </div>"""
        ),
        popup=tipo
    ).add_to(m)

# === 9. Agregar HeatMap con rampa Jet / Rainbow ===
heat_data = [[point.y, point.x] for point in gdf.geometry]
heat_layer = HeatMap(
    heat_data,
    name="Mapa de Calor",
    radius=25,
    blur=20,
    max_zoom=12,
    min_opacity=0.4,
    gradient={
        0.0: '#0000FF',
        0.2: '#00FFFF',
        0.4: '#00FF00',
        0.6: '#FFFF00',
        0.8: '#FFA500',
        1.0: '#FF0000'
    }
)
heat_layer.add_to(m)

# === 10. Leyenda flotante con estrellas ===
items_html = ""
for tipo, color in color_por_tipo.items():
    items_html += f"<li style='list-style:none;'><span style='color:{color}; font-size:16px; text-shadow:-1px -1px 1px #111, 1px -1px 1px #111, -1px 1px 1px #111, 1px 1px 1px #111;'>‚òÖ</span> {tipo}</li>"

legend_html = f"""
<div id='legend' style="
position: fixed;
bottom: 50px;
left: 50px;
z-index: 9999;
background-color: rgba(255, 255, 255, 0.9);
padding: 12px;
border-radius: 10px;
box-shadow: 0 2px 6px rgba(0,0,0,0.3);
font-family: Arial, sans-serif;
font-size: 13px;
">
<b>Leyenda - Capa Base:</b><br>
<ul style='margin: 5px 0; padding-left: 15px;'>
{items_html}
</ul>
</div>
"""
m.get_root().html.add_child(folium.Element(legend_html))

# === 11. JS para leyenda, tama√±o din√°mico y opacidad adaptativa ===
js_code = f"""
<script>
// Ajusta la leyenda seg√∫n la capa base
function updateLegend(name) {{
    var colors = {{
        "OSM Est√°ndar": {{texto:"#4A4A4A", opacidad:0.85, heat:0.6}},
        "Google Maps - Calles": {{texto:"#2E2E2E", opacidad:0.7, heat:0.5}},
        "Google Sat√©lite": {{texto:"#FFFFFF", opacidad:1.0, heat:0.75}}
    }};
    var c = colors[name];
    if (!c) return;

    // Actualizar leyenda
    document.getElementById('legend').innerHTML = `
        <b>Leyenda - ${'{'}name{'}'}:</b><br>
        <ul style='margin: 5px 0; padding-left: 15px;'>
            {items_html}
        </ul>`;

    // Ajustar opacidad de estrellas
    var stars = document.getElementsByClassName('star-icon');
    for (var i = 0; i < stars.length; i++) {{
        stars[i].style.opacity = c.opacidad;
    }}

    // Ajustar opacidad del HeatMap
    for (var layer in map._layers) {{
        var l = map._layers[layer];
        if (l instanceof L.HeatLayer) {{
            l.setOptions({{minOpacity: c.heat}});
        }}
    }}
}}

// Ajuste din√°mico del tama√±o de estrellas seg√∫n zoom
map.on('zoomend', function() {{
    var zoom = map.getZoom();
    var size = 10 + (zoom * 0.8);
    var stars = document.getElementsByClassName('star-icon');
    for (var i = 0; i < stars.length; i++) {{
        stars[i].style.fontSize = size + 'px';
    }}
}});

// Evento para cambiar capa base
map.on('baselayerchange', function(e) {{
    updateLegend(e.name);
}});
</script>
"""
m.get_root().html.add_child(folium.Element(js_code))

# === 12. Control de capas ===
folium.LayerControl(collapsed=False).add_to(m)

# === 13. Guardar y descargar ===
output_html = "mapa_estrellas_heatmap_jet_adaptativo.html"
m.save(output_html)
print(f"‚úÖ Mapa guardado en {output_html}")
files.download(output_html)

# Mostrar en Colab
m
